# DETECT Snakemake 9 - Changelog

## Recent Updates

### Interactive Configuration System with SLURM Batch Support

**Date:** 2025-11-06

#### New Features

1. **Enhanced create_config.sh Script**
   - Added SLURM job submission parameter prompts:
     - Partition (default: `public`)
     - Time limit (default: `4-00:00:00`)
     - QOS - Quality of Service (default: `public`)
     - Job name (default: `detect_workflow`)
   - Generates three output scripts instead of two
   - Color-coded prompts and validation

2. **New sbatch_run.sh Script**
   - SLURM batch submission script with proper SBATCH directives
   - Runs Snakemake as a SLURM job (recommended for production)
   - Captures stdout to `o-<jobid>.out` and stderr to `e-<jobid>.err`
   - Configurable partition, time limit, QOS, and job name
   - Automatically calls config.sh to generate config.json

3. **Enhanced Documentation**
   - Updated README.md with three workflow execution options
   - Enhanced WORKFLOW_GUIDE.md with SLURM parameter documentation
   - Added usage examples for batch submission

#### Scripts Generated by create_config.sh

Running `bash scripts/create_config.sh` now creates:

1. **config.sh** - Generates config.json from DETECT/create_config.py
2. **run.sh** - Interactive execution on login node
3. **sbatch_run.sh** - SLURM batch submission (NEW)

#### Usage Recommendations

**For Production Workflows:**
```bash
bash scripts/create_config.sh  # Configure workflow
sbatch sbatch_run.sh           # Submit as batch job
snakejobs                      # Monitor with rule names
```

**For Testing/Small Workflows:**
```bash
bash scripts/create_config.sh  # Configure workflow
./run.sh                       # Run interactively
```

#### SLURM Configuration

The sbatch_run.sh script includes these SBATCH directives:
- `-n 1` - Single task (Snakemake controller)
- `-c 2` - Two cores for Snakemake process
- `-t` - Time limit (user-specified)
- `-p` - Partition (user-specified)
- `-q` - QOS (user-specified)
- `--job-name` - Job name (user-specified)
- `-o o-%j.out` - Standard output file
- `-e e-%j.err` - Standard error file

Individual workflow rules are submitted as separate SLURM jobs via the `profiles/slurm` profile.

---

### Job Viewing Enhancement

**Date:** 2025-11-06

#### New snakejobs Script

Created enhanced job viewing script based on cluster's `myjobs`:
- Adds **RULE** column showing Snakemake rule names
- Maintains all myjobs formatting (Priority, Node/Core/GPU, etc.)
- Installed via `scripts/install_snakejobs.sh`

**Installation:**
```bash
bash scripts/install_snakejobs.sh
```

**Usage:**
```bash
myjobs      # System command - standard view
snakejobs   # Enhanced view with RULE column
```

---

### Snakemake 9 Migration

**Date:** 2025-11-04

#### Breaking Changes

- **SLURM Job Names**: Now appear as UUIDs instead of rule names (Snakemake 8+ design)
- **Solution**: Rule names stored in SLURM comment field, viewable with `snakejobs` script

#### SLURM Profile Configuration

Updated `profiles/slurm/config.yaml` and `profiles/slurmexec/config.yaml`:
- Executor: `slurm` (plugin-based)
- Job tracking via unique job names
- Rule names in comment field

---

## File Structure

```
sn9-detect/
├── scripts/
│   ├── create_config.sh       # Interactive configuration generator
│   ├── install_snakejobs.sh   # Install job viewing script
│   ├── snakejobs               # Enhanced job viewer with rule names
│   ├── test_config.sh          # Test configuration validity
│   ├── config.sh               # Example config generation (demo)
│   └── sbatch.sh               # Example SLURM submission
├── profiles/
│   ├── slurm/                  # SLURM profile (1 core default)
│   └── slurmexec/              # SLURM profile (4 cores default)
├── DETECT/
│   ├── create_config.py        # Config.json generator
│   ├── Snakefile               # Snakemake 9 workflow
│   └── DETECT.yml              # Conda environment
├── README.md                   # Quick start guide
├── WORKFLOW_GUIDE.md           # Comprehensive parameter documentation
└── CHANGELOG.md                # This file
```

## Generated Files (from create_config.sh)

When you run the interactive configuration:

```
./
├── config.sh          # Generates config.json
├── run.sh             # Interactive execution
├── sbatch_run.sh      # SLURM batch submission
└── work/
    └── config/
        └── config.json  # Workflow configuration
```

After SLURM submission:

```
./
├── o-<jobid>.out      # Standard output
├── e-<jobid>.err      # Standard error
└── output/
    └── DETECT_output.*.txt  # Results
```

## Quick Reference

### Configuration
```bash
bash scripts/create_config.sh
```

### Testing
```bash
bash scripts/test_config.sh
```

### Execution
```bash
# Batch (recommended)
sbatch sbatch_run.sh

# Interactive
./run.sh

# Manual
./config.sh
snakemake -p --profile profiles/slurm --configfile work/config/config.json -s DETECT/Snakefile
```

### Monitoring
```bash
# Standard SLURM view
squeue -u $USER

# Enhanced view with rule names
snakejobs

# View specific job output
tail -f o-<jobid>.out
tail -f e-<jobid>.err
```

## Support

For issues, questions, or contributions:
- Check WORKFLOW_GUIDE.md for detailed parameter documentation
- Check README.md for quick start instructions
- Review DETECT/README.md for original workflow documentation
